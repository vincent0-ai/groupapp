{% extends "base.html" %}

{% block title %}Admin Dashboard - Discussio{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4" style="background: linear-gradient(135deg, #dc3545 0%, #6f42c1 100%); border-radius: 20px; padding: 2rem; color: white;">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-shield-alt fa-2x"></i>
            </div>
            <div>
                <h1 class="mb-1" style="font-size: 1.75rem; font-weight: 700;">Admin Dashboard</h1>
                <p class="mb-0 opacity-75">Manage users, groups, and channels</p>
            </div>
        </div>
        <div id="adminStats" class="d-flex gap-3">
            <!-- Stats will be loaded here -->
        </div>
    </div>
</div>

<div class="nav-tabs-container mb-4" style="background: #f8f5f0; border-radius: 12px; padding: 6px;">
    <ul class="nav nav-tabs border-0" id="adminTabs" role="tablist" style="gap: 4px;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" style="border: none; border-radius: 8px; padding: 10px 20px; font-weight: 500; color: var(--text-dark);">
                <i class="fas fa-users me-2"></i>Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" style="border: none; border-radius: 8px; padding: 10px 20px; font-weight: 500; color: var(--text-dark);">
                <i class="fas fa-layer-group me-2"></i>Groups
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="channels-tab" data-bs-toggle="tab" data-bs-target="#channels" type="button" role="tab" style="border: none; border-radius: 8px; padding: 10px 20px; font-weight: 500; color: var(--text-dark);">
                <i class="fas fa-hashtag me-2"></i>Channels
            </button>
        </li>
    </ul>
</div>

<div class="tab-content" id="adminTabContent">
    <!-- Users Tab -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; overflow: hidden;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-users text-primary me-2"></i>User Management</h5>
                    <div class="search-wrapper position-relative">
                        <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                        <input type="text" class="form-control" id="userSearch" placeholder="Search users..." style="padding-left: 38px; border-radius: 10px; min-width: 250px;">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th style="border-top: none; font-weight: 600;">User</th>
                                <th style="border-top: none; font-weight: 600;">Email</th>
                                <th style="border-top: none; font-weight: 600;">Status</th>
                                <th style="border-top: none; font-weight: 600;">Joined</th>
                                <th style="border-top: none; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <nav aria-label="User pagination">
            <ul class="pagination justify-content-center" id="userPagination"></ul>
        </nav>
    </div>

    <!-- Groups Tab -->
    <div class="tab-pane fade" id="groups" role="tabpanel">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; overflow: hidden;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-layer-group text-primary me-2"></i>Group Management</h5>
                    <div class="search-wrapper position-relative">
                        <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                        <input type="text" class="form-control" id="groupSearch" placeholder="Search groups..." style="padding-left: 38px; border-radius: 10px; min-width: 250px;">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th style="border-top: none; font-weight: 600;">Name</th>
                                <th style="border-top: none; font-weight: 600;">Owner</th>
                                <th style="border-top: none; font-weight: 600;">Members</th>
                                <th style="border-top: none; font-weight: 600;">Created</th>
                                <th style="border-top: none; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="groupsTableBody">
                            <!-- Groups will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <nav aria-label="Group pagination">
            <ul class="pagination justify-content-center" id="groupPagination"></ul>
        </nav>
    </div>

    <!-- Channels Tab -->
    <div class="tab-pane fade" id="channels" role="tabpanel">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; overflow: hidden;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-hashtag text-primary me-2"></i>Channel Management</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th style="border-top: none; font-weight: 600;">Name</th>
                                <th style="border-top: none; font-weight: 600;">Description</th>
                                <th style="border-top: none; font-weight: 600;">Groups</th>
                                <th style="border-top: none; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="channelsTableBody">
                            <!-- Channels will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/auth';
        return;
    }

    // Check admin status
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        // We might need to fetch user profile to confirm admin status if not in token
        // But for now let's try to load stats, if it fails (403), redirect
        await loadStats();
    } catch (e) {
        console.error(e);
        alert('Access denied');
        window.location.href = '/';
    }

    // Load initial data
    loadUsers();
    loadGroups();
    loadChannels();

    // Search listeners
    let userSearchTimeout;
    document.getElementById('userSearch').addEventListener('input', (e) => {
        clearTimeout(userSearchTimeout);
        userSearchTimeout = setTimeout(() => loadUsers(1, e.target.value), 500);
    });

    let groupSearchTimeout;
    document.getElementById('groupSearch').addEventListener('input', (e) => {
        clearTimeout(groupSearchTimeout);
        groupSearchTimeout = setTimeout(() => loadGroups(1, e.target.value), 500);
    });
});

async function apiCall(endpoint, method = 'GET', body = null) {
    const token = localStorage.getItem('token');
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
    
    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);

    const response = await fetch(`/api/admin${endpoint}`, options);
    if (response.status === 401) {
        window.location.href = '/auth';
        return;
    }
    if (response.status === 403) {
        alert('Admin privileges required');
        window.location.href = '/';
        return;
    }
    return response.json();
}

async function loadStats() {
    const res = await apiCall('/stats');
    if (res.status === 'success') {
        const stats = res.data;
        document.getElementById('adminStats').innerHTML = `
            <span><i class="fas fa-users"></i> ${stats.total_users} Users</span>
            <span><i class="fas fa-layer-group"></i> ${stats.total_groups} Groups</span>
            <span><i class="fas fa-hashtag"></i> ${stats.total_channels} Channels</span>
        `;
    }
}

async function loadUsers(page = 1, search = '') {
    const res = await apiCall(`/users?page=${page}&search=${search}`);
    if (res.status === 'success') {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = res.data.users.map(user => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${user.avatar_url}" class="rounded-circle me-2" width="32" height="32">
                        <div>
                            <div class="fw-bold">${user.username}</div>
                            <div class="small text-muted">${user.full_name}</div>
                        </div>
                    </div>
                </td>
                <td>${user.email}</td>
                <td>
                    <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                        ${user.is_active ? 'Active' : 'Banned'}
                    </span>
                    ${user.is_admin ? '<span class="badge bg-primary">Admin</span>' : ''}
                </td>
                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                <td>
                    ${!user.is_admin ? `
                        <button class="btn btn-sm btn-${user.is_active ? 'danger' : 'success'}" 
                                onclick="toggleBan('${user._id}', ${user.is_active})">
                            ${user.is_active ? 'Ban' : 'Unban'}
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
        
        renderPagination('userPagination', res.data.page, res.data.pages, (p) => loadUsers(p, search));
    }
}

async function toggleBan(userId, isActive) {
    if (!confirm(`Are you sure you want to ${isActive ? 'ban' : 'unban'} this user?`)) return;
    
    const endpoint = `/users/${userId}/${isActive ? 'ban' : 'unban'}`;
    const res = await apiCall(endpoint, 'POST');
    
    if (res.status === 'success') {
        loadUsers(1, document.getElementById('userSearch').value);
    } else {
        alert(res.message);
    }
}

async function loadGroups(page = 1, search = '') {
    const res = await apiCall(`/groups?page=${page}&search=${search}`);
    if (res.status === 'success') {
        const tbody = document.getElementById('groupsTableBody');
        tbody.innerHTML = res.data.groups.map(group => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${group.avatar_url}" class="rounded-circle me-2" width="32" height="32">
                        ${group.name}
                    </div>
                </td>
                <td>${group.owner_id}</td> <!-- Ideally fetch owner name -->
                <td>${group.members.length}</td>
                <td>${new Date(group.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group._id}')">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');
        
        renderPagination('groupPagination', res.data.page, res.data.pages, (p) => loadGroups(p, search));
    }
}

async function deleteGroup(groupId) {
    if (!confirm('Are you sure you want to delete this group? This cannot be undone.')) return;
    
    const res = await apiCall(`/groups/${groupId}`, 'DELETE');
    if (res.status === 'success') {
        loadGroups(1, document.getElementById('groupSearch').value);
        loadStats();
    } else {
        alert(res.message);
    }
}

async function loadChannels() {
    const res = await apiCall('/channels');
    if (res.status === 'success') {
        const tbody = document.getElementById('channelsTableBody');
        tbody.innerHTML = res.data.map(channel => `
            <tr>
                <td>${channel.name}</td>
                <td>${channel.description}</td>
                <td>${channel.group_count || 0}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteChannel('${channel._id}')">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

async function deleteChannel(channelId) {
    if (!confirm('Are you sure you want to delete this channel?')) return;
    
    const res = await apiCall(`/channels/${channelId}`, 'DELETE');
    if (res.status === 'success') {
        loadChannels();
        loadStats();
    } else {
        alert(res.message);
    }
}

function renderPagination(elementId, currentPage, totalPages, callback) {
    const container = document.getElementById(elementId);
    let html = '';
    
    if (totalPages > 1) {
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? 'callback(' + (currentPage - 1) + ')' : ''}">Previous</a>
            </li>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); callback(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? 'callback(' + (currentPage + 1) + ')' : ''}">Next</a>
            </li>
        `;
    }
    
    container.innerHTML = html;
    
    // Attach callback to window so onclick works (hacky but simple)
    // Better to add event listeners but this is quick
    window.callback = callback; 
    // Wait, window.callback will be overwritten. 
    // We need to bind the callback properly.
    // The onclick in HTML string refers to global scope.
    // Let's fix this by not using inline onclick for the callback logic if possible, 
    // or by assigning unique global functions.
    // Actually, since I'm generating HTML string, I can't easily pass the closure 'callback'.
    // I'll just assign it to a property on the element and use event delegation or just use a global helper.
}

// Fix for pagination callback
window.loadUsersPage = (p) => loadUsers(p, document.getElementById('userSearch').value);
window.loadGroupsPage = (p) => loadGroups(p, document.getElementById('groupSearch').value);

// Re-implement renderPagination to use specific global functions
function renderPagination(elementId, currentPage, totalPages, callback) {
    const container = document.getElementById(elementId);
    const callbackName = elementId === 'userPagination' ? 'loadUsersPage' : 'loadGroupsPage';
    
    let html = '';
    
    if (totalPages > 1) {
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${callbackName}(${currentPage - 1})">Previous</a>
            </li>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); ${callbackName}(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${callbackName}(${currentPage + 1})">Next</a>
            </li>
        `;
    }
    
    container.innerHTML = html;
}
</script>
{% endblock %}
