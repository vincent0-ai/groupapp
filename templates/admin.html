{% extends "base.html" %}

{% block title %}Admin Dashboard - Discussio{% endblock %}

{% block head %}
<style>
    .admin-header {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.3) 0%, rgba(124, 58, 237, 0.3) 100%);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid rgba(124, 58, 237, 0.3);
        backdrop-filter: blur(10px);
    }
    
    .admin-header h1 {
        color: #E5E7EB;
    }
    
    .admin-header p {
        color: #9CA3AF;
    }
    
    .admin-tabs {
        background: rgba(26, 23, 48, 0.9);
        border-radius: 12px;
        padding: 6px;
        border: 1px solid rgba(124, 58, 237, 0.3);
    }
    
    .admin-tabs .nav-link {
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        color: #9CA3AF;
        background: transparent;
    }
    
    .admin-tabs .nav-link.active {
        background: rgba(124, 58, 237, 0.3);
        color: #E5E7EB;
    }
    
    .admin-tabs .nav-link:hover:not(.active) {
        color: #E5E7EB;
    }
    
    .admin-card {
        background: rgba(26, 23, 48, 0.9);
        border: 1px solid rgba(124, 58, 237, 0.3);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        color: #E5E7EB;
    }
    
    .admin-card h5 {
        color: #E5E7EB;
    }
    
    .admin-card .list-group-item {
        background: rgba(124, 58, 237, 0.1);
        border-color: rgba(124, 58, 237, 0.2);
        color: #E5E7EB;
    }
    
    .admin-card .list-group-item .text-muted {
        color: #9CA3AF !important;
    }
    
    .admin-card .form-control {
        background: rgba(26, 23, 48, 0.9);
        border: 1px solid rgba(124, 58, 237, 0.3);
        color: #E5E7EB;
    }
    
    .admin-card .form-control:focus {
        border-color: #7C3AED;
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }
    
    .admin-card .form-control::placeholder {
        color: #6B7280;
    }
    
    .pagination .page-link {
        background: rgba(26, 23, 48, 0.9);
        border-color: rgba(124, 58, 237, 0.3);
        color: #E5E7EB;
    }
    
    .pagination .page-link:hover {
        background: rgba(124, 58, 237, 0.3);
    }
    
    .pagination .page-item.active .page-link {
        background: #7C3AED;
        border-color: #7C3AED;
    }
    
    .pagination .page-item.disabled .page-link {
        background: rgba(26, 23, 48, 0.5);
        color: #6B7280;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h1 class="mb-1" style="font-size: 1.75rem; font-weight: 700;">üõ°Ô∏è Admin Dashboard</h1>
                <p class="mb-0">Manage users, groups, and channels</p>
            </div>
        </div>
        <div id="adminStats" class="d-flex gap-3 align-items-center" style="color: #E5E7EB;">
            <!-- Stats will be loaded here -->
            <button id="adminCreateSeasonBtn" class="btn btn-sm btn-outline-light ms-3" title="Create Season" onclick="window.location.href='/seasons?showCreate=1'">
                Create Season
            </button>
        </div>
    </div>
</div>

<div class="admin-tabs mb-4">
    <ul class="nav nav-tabs border-0" id="adminTabs" role="tablist" style="gap: 4px;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab">
                Groups
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="channels-tab" data-bs-toggle="tab" data-bs-target="#channels" type="button" role="tab">
                Channels
            </button>
        </li>
    </ul>
</div>

<div class="tab-content" id="adminTabContent">
    <!-- Users Tab -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="card admin-card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold">User Management</h5>
                    <div class="search-wrapper position-relative">
                        <input type="text" class="form-control" id="userSearch" placeholder="üîç Search users..." style="border-radius: 10px; min-width: 250px;">
                    </div>
                </div>
                <!-- List view (replaces table for normal display) -->
                <div id="usersList" class="list-group">
                    <div class="list-group-item text-center py-4">Loading users...</div>
                </div>
            </div>
        </div>
        <nav aria-label="User pagination">
            <ul class="pagination justify-content-center" id="userPagination"></ul>
        </nav>
    </div>

    <!-- Groups Tab -->
    <div class="tab-pane fade" id="groups" role="tabpanel">
        <div class="card admin-card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold">Group Management</h5>
                    <div class="search-wrapper position-relative">
                        <input type="text" class="form-control" id="groupSearch" placeholder="Search groups..." style="border-radius: 10px; min-width: 250px;">
                    </div>
                </div>
                <!-- List view (replaces table for normal display) -->
                <div id="groupsList" class="list-group">
                    <div class="list-group-item text-center py-4">Loading groups...</div>
                </div>
            </div>
        </div>
        <nav aria-label="Group pagination">
            <ul class="pagination justify-content-center" id="groupPagination"></ul>
        </nav>
    </div>

    <!-- Channels Tab -->
    <div class="tab-pane fade" id="channels" role="tabpanel">
        <div class="card admin-card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold">Channel Management</h5>
                </div>
                <!-- List view (replaces table for normal display) -->
                <div id="channelsList" class="list-group">
                    <div class="list-group-item text-center py-4">Loading channels...</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/auth';
        return;
    }

    // Check admin status
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        // We might need to fetch user profile to confirm admin status if not in token
        // But for now let's try to load stats, if it fails (403), redirect
        await loadStats();
    } catch (e) {
        console.error(e);
        alert('Access denied');
        window.location.href = '/';
    }

    // Load initial data
    loadUsers();
    loadGroups();
    loadChannels();

    // Search listeners
    let userSearchTimeout;
    document.getElementById('userSearch').addEventListener('input', (e) => {
        clearTimeout(userSearchTimeout);
        userSearchTimeout = setTimeout(() => loadUsers(1, e.target.value), 500);
    });

    let groupSearchTimeout;
    document.getElementById('groupSearch').addEventListener('input', (e) => {
        clearTimeout(groupSearchTimeout);
        groupSearchTimeout = setTimeout(() => loadGroups(1, e.target.value), 500);
    });
});

async function apiCall(endpoint, method = 'GET', body = null) {
    const token = localStorage.getItem('token');
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
    
    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);

    const response = await fetch(`/api/admin${endpoint}`, options);
    if (response.status === 401) {
        window.location.href = '/auth';
        return;
    }
    if (response.status === 403) {
        alert('Admin privileges required');
        window.location.href = '/';
        return;
    }
    return response.json();
}

async function loadStats() {
    const res = await apiCall('/stats');
    if (res.status === 'success') {
        const stats = res.data;
        document.getElementById('adminStats').innerHTML = `
            <span>${stats.total_users} Users</span>
            <span>${stats.total_groups} Groups</span>
            <span>${stats.total_channels} Channels</span>
            <button id="adminCreateSeasonBtn" class="btn btn-sm btn-outline-light ms-3" title="Create Season" onclick="window.location.href='/seasons?showCreate=1'">
                Create Season
            </button>
        `;
    }
}

async function loadUsers(page = 1, search = '') {
    const res = await apiCall(`/users?page=${page}&search=${search}`);
    if (res.status === 'success') {
        const container = document.getElementById('usersList');
        const users = res.data.users || [];

        if (users.length === 0) {
            container.innerHTML = '<div class="list-group-item text-center text-muted">No users found</div>';
        } else {
            container.innerHTML = users.map(user => `
                <div class="list-group-item d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <img src="${user.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.username}" class="rounded-circle me-3" width="48" height="48">
                        <div>
                            <div class="fw-bold">${user.username} ${user.is_admin ? '<span class="badge bg-primary ms-2">Admin</span>' : ''}</div>
                            <div class="small text-muted">${user.full_name || ''} ¬∑ ${user.email || ''}</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="mb-1">
                            <span class="badge bg-${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'Active' : 'Banned'}</span>
                        </div>
                        <div class="small text-muted">Joined ${new Date(user.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="ms-3">
                        ${!user.is_admin ? `
                            <button class="btn btn-sm btn-${user.is_active ? 'danger' : 'success'}" onclick="toggleBan('${user._id}', ${user.is_active})">${user.is_active ? 'Ban' : 'Unban'}</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        renderPagination('userPagination', res.data.page, res.data.pages, (p) => loadUsers(p, search));
    }
}

async function toggleBan(userId, isActive) {
    if (!confirm(`Are you sure you want to ${isActive ? 'ban' : 'unban'} this user?`)) return;
    
    const endpoint = `/users/${userId}/${isActive ? 'ban' : 'unban'}`;
    const res = await apiCall(endpoint, 'POST');
    
    if (res.status === 'success') {
        loadUsers(1, document.getElementById('userSearch').value);
    } else {
        alert(res.message);
    }
}

async function loadGroups(page = 1, search = '') {
    const res = await apiCall(`/groups?page=${page}&search=${search}`);
    if (res.status === 'success') {
        const container = document.getElementById('groupsList');
        const groups = res.data.groups || [];

        if (groups.length === 0) {
            container.innerHTML = '<div class="list-group-item text-center text-muted">No groups found</div>';
        } else {
            container.innerHTML = groups.map(group => `
                <div class="list-group-item d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <img src="${group.avatar_url || 'https://api.dicebear.com/7.x/identicon/svg?seed=' + group.name}" class="rounded-circle me-3" width="48" height="48">
                        <div>
                            <div class="fw-bold">${group.name}</div>
                            <div class="small text-muted">Owner: ${group.owner_id || '-'} ¬∑ Members: ${group.members?.length || 0}</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="small text-muted">Created ${new Date(group.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="ms-3">
                        <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group._id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        renderPagination('groupPagination', res.data.page, res.data.pages, (p) => loadGroups(p, search));
    }
}

async function deleteGroup(groupId) {
    if (!confirm('Are you sure you want to delete this group? This cannot be undone.')) return;
    
    const res = await apiCall(`/groups/${groupId}`, 'DELETE');
    if (res.status === 'success') {
        loadGroups(1, document.getElementById('groupSearch').value);
        loadStats();
    } else {
        alert(res.message);
    }
}

async function loadChannels() {
    const res = await apiCall('/channels');
    if (res.status === 'success') {
        const container = document.getElementById('channelsList');
        const channels = res.data || [];

        if (channels.length === 0) {
            container.innerHTML = '<div class="list-group-item text-center text-muted">No channels found</div>';
        } else {
            container.innerHTML = channels.map(channel => `
                <div class="list-group-item d-flex align-items-center justify-content-between">
                    <div>
                        <div class="fw-bold">${channel.name}</div>
                        <div class="small text-muted">${channel.description || ''}</div>
                    </div>
                    <div class="text-end small text-muted">Groups: ${channel.group_count || 0}</div>
                    <div class="ms-3">
                        <button class="btn btn-sm btn-danger" onclick="deleteChannel('${channel._id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
    }
}

async function deleteChannel(channelId) {
    if (!confirm('Are you sure you want to delete this channel?')) return;
    
    const res = await apiCall(`/channels/${channelId}`, 'DELETE');
    if (res.status === 'success') {
        loadChannels();
        loadStats();
    } else {
        alert(res.message);
    }
}

function renderPagination(elementId, currentPage, totalPages, callback) {
    const container = document.getElementById(elementId);
    let html = '';
    
    if (totalPages > 1) {
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? 'callback(' + (currentPage - 1) + ')' : ''}">Previous</a>
            </li>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); callback(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? 'callback(' + (currentPage + 1) + ')' : ''}">Next</a>
            </li>
        `;
    }
    
    container.innerHTML = html;
    
    // Attach callback to window so onclick works (hacky but simple)
    // Better to add event listeners but this is quick
    window.callback = callback; 
    // Wait, window.callback will be overwritten. 
    // We need to bind the callback properly.
    // The onclick in HTML string refers to global scope.
    // Let's fix this by not using inline onclick for the callback logic if possible, 
    // or by assigning unique global functions.
    // Actually, since I'm generating HTML string, I can't easily pass the closure 'callback'.
    // I'll just assign it to a property on the element and use event delegation or just use a global helper.
}

// Fix for pagination callback
window.loadUsersPage = (p) => loadUsers(p, document.getElementById('userSearch').value);
window.loadGroupsPage = (p) => loadGroups(p, document.getElementById('groupSearch').value);

// Re-implement renderPagination to use specific global functions
function renderPagination(elementId, currentPage, totalPages, callback) {
    const container = document.getElementById(elementId);
    const callbackName = elementId === 'userPagination' ? 'loadUsersPage' : 'loadGroupsPage';
    
    let html = '';
    
    if (totalPages > 1) {
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${callbackName}(${currentPage - 1})">Previous</a>
            </li>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); ${callbackName}(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); ${callbackName}(${currentPage + 1})">Next</a>
            </li>
        `;
    }
    
    container.innerHTML = html;
}
</script>
{% endblock %}
