{% extends "base.html" %}

{% block title %}Whiteboard - Discussio{% endblock %}

{% block head %}
<style>
    canvas {
        border: 2px solid var(--border-color);
        background: #fff;
        cursor: crosshair;
        border-radius: 8px;
        touch-action: none;
    }

    .controls {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chalkboard"></i> Collaborative Whiteboard</h1>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-2">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="card-title">Drawing Tools</h6>
                <div class="controls mb-3">
                    <label for="colorPicker" class="form-label">Color</label>
                    <input type="color" class="form-control form-control-color" id="colorPicker" value="#000000">
                </div>
                <div class="controls mb-3">
                    <label for="brushSize" class="form-label">Brush Size: <span id="sizeValue">3</span>px</label>
                    <input type="range" class="form-range" id="brushSize" min="1" max="20" value="3">
                </div>
                <div class="controls mb-3">
                    <label for="opacity" class="form-label">Opacity</label>
                    <input type="range" class="form-range" id="opacity" min="0" max="1" step="0.1" value="1">
                </div>
                <div class="btn-group-vertical w-100">
                    <button id="clearBtn" class="btn btn-warning mb-2">
                        <i class="fas fa-trash"></i> Clear Canvas
                    </button>
                    <button id="undoBtn" class="btn btn-secondary mb-2">
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button id="downloadBtn" class="btn btn-info">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>

        <div class="card mt-3 shadow-sm border-0">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-users"></i> Participants</h6>
            </div>
            <div class="card-body" id="participants">
                <small class="text-body-secondary">Connecting...</small>
            </div>
        </div>
    </div>

    <div class="col-lg-10">
        <div class="card shadow-sm border-0">
            <div class="card-body overflow-auto text-center bg-light">
                <canvas id="whiteboard" width="1200" height="600"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    (() => {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');

        if (!token || !userId) {
            window.location.href = "{{ url_for('auth_page') }}";
            return;
        }

        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        const participantsEl = document.getElementById('participants');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let history = [];

        const socket = io();

        const colorPicker = document.getElementById('colorPicker');
        const brushSize = document.getElementById('brushSize');
        const opacity = document.getElementById('opacity');

        brushSize.addEventListener('input', (e) => {
            document.getElementById('sizeValue').textContent = e.target.value;
        });

        function getPos(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function draw(x0, y0, x1, y1, color, size, alpha) {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.strokeStyle = color ?? colorPicker.value;
            ctx.lineWidth = size ?? Number(brushSize.value);
            ctx.globalAlpha = alpha ?? Number(opacity.value);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            ctx.globalAlpha = 1;
        }

        function saveHistory() {
            try {
                history.push(canvas.toDataURL());
            } catch {
                // ignore
            }
        }

        function emitDraw(x0, y0, x1, y1) {
            socket.emit('whiteboard_draw', {
                room: 'whiteboard',
                user_id: userId,
                drawing_data: {
                    x0,
                    y0,
                    x1,
                    y1,
                    color: colorPicker.value,
                    size: Number(brushSize.value),
                    opacity: Number(opacity.value)
                }
            });
        }

        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const p = getPos(e.clientX, e.clientY);
            lastX = p.x;
            lastY = p.y;
            saveHistory();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const p = getPos(e.clientX, e.clientY);
            draw(lastX, lastY, p.x, p.y);
            emitDraw(lastX, lastY, p.x, p.y);
            lastX = p.x;
            lastY = p.y;
        });

        function stopDrawing() {
            isDrawing = false;
        }

        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const t = e.touches[0];
            isDrawing = true;
            const p = getPos(t.clientX, t.clientY);
            lastX = p.x;
            lastY = p.y;
            saveHistory();
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const t = e.touches[0];
            const p = getPos(t.clientX, t.clientY);
            draw(lastX, lastY, p.x, p.y);
            emitDraw(lastX, lastY, p.x, p.y);
            lastX = p.x;
            lastY = p.y;
        }, { passive: false });

        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);

        // Controls
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (await showCustomConfirm('Clear the entire whiteboard?', 'Confirm Clear')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                history = [];
            }
        });

        document.getElementById('undoBtn').addEventListener('click', () => {
            if (history.length === 0) return;
            history.pop();
            if (history.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const img = new Image();
            img.src = history[history.length - 1];
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL();
            link.download = 'whiteboard-' + new Date().getTime() + '.png';
            link.click();
        });

        // Socket events
        socket.on('connect_response', () => {
            if (participantsEl) {
                participantsEl.innerHTML = '<small class="text-body-secondary">Connected</small>';
            }
        });

        socket.on('draw_update', (data) => {
            const d = data?.drawing_data;
            if (!d) return;
            draw(d.x0, d.y0, d.x1, d.y1, d.color, d.size, d.opacity);
        });

        // Join room
        socket.emit('join_room', { room: 'whiteboard', user_id: userId });
    })();
</script>
{% endblock %}