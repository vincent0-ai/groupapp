{% extends "base.html" %}

{% block title %}Groups - Discussio{% endblock %}

{% block head %}
<style>
    .page-header {
        background: var(--primary-ultra-light);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }
    
    .page-header h1 {
        font-weight: 700;
        margin-bottom: 0;
        color: #0F172A;
    }
    
    .page-header h1 i {
        color: #4F46E5;
    }
    
    .nav-tabs {
        border: none;
        background: var(--background-color);
        border-radius: 10px;
        padding: 4px;
        gap: 4px;
        display: inline-flex;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-weight: 600;
        color: var(--text-muted);
        transition: all 0.15s ease;
    }
    
    .nav-tabs .nav-link:hover {
        background: rgba(79, 70, 229, 0.08);
        color: var(--primary-color);
    }
    
    .nav-tabs .nav-link.active {
        background: #4F46E5;
        color: white;
        box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
    }
    
    .group-card {
        border: 1px solid var(--border-color);
        transition: box-shadow 0.15s ease;
        height: 100%;
    }
    
    .group-card:hover {
        box-shadow: var(--shadow-md);
    }
    
    .group-card .card-header {
        background: transparent !important;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-heading) !important;
    }
    
    .group-card .card-header h5 {
        color: var(--text-heading) !important;
    }
    
    .group-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        margin-right: 0.875rem;
    }
    
    .group-icon.public { background: rgba(34, 197, 94, 0.1); color: #22C55E; }
    .group-icon.private { background: rgba(79, 70, 229, 0.1); color: #4F46E5; }
    
    .member-count {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--background-color);
        border-radius: 50px;
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    
    .channel-accordion .accordion-button {
        font-weight: 600;
        padding: 0.875rem 1rem;
        background: var(--card-bg);
    }
    
    .channel-accordion .accordion-button:not(.collapsed) {
        background: rgba(79, 70, 229, 0.06);
        color: var(--primary-color);
    }
    
    .channel-accordion .accordion-item {
        border: 1px solid var(--border-color);
        background: var(--card-bg);
    }
    
    .empty-state {
        text-align: center;
        padding: 2.5rem 1.25rem;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: var(--text-light);
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
        <div class="page-header d-flex flex-wrap justify-content-between align-items-center">
            <div>
                <h1>Groups</h1>
            </div>
            <div class="mt-2 mt-md-0">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                    <i class="fas fa-plus me-2"></i>Create Group
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#myGroups" data-bs-toggle="tab">My Groups</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#joinGroups" data-bs-toggle="tab">Available Groups</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#pendingRequests" data-bs-toggle="tab" id="pendingRequestsTab" style="display: none;">Requests</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- My Groups Tab -->
            <div class="tab-pane fade show active" id="myGroups">
                <div class="row g-4" id="myGroupsList">
                    <div class="col-12">
                        <div class="empty-state">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-3 mb-0">Loading groups...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Groups Tab -->
            <div class="tab-pane fade" id="joinGroups">
                <div class="accordion channel-accordion" id="availableGroupsAccordion">
                    <div class="empty-state">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-3 mb-0">Loading channels...</p>
                    </div>
                </div>
            </div>

            <!-- Pending Requests Tab -->
            <div class="tab-pane fade" id="pendingRequests">
                <div class="row g-4" id="pendingRequestsList">
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p class="text-muted mb-0">No pending requests.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block modals %}
    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createGroupForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="groupName" class="form-label">Group Name</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupCategory" class="form-label">Channel Category</label>
                            <input type="text" class="form-control" id="groupCategory" placeholder="e.g. Science, Games, School" list="categoryList">
                            <datalist id="categoryList">
                                <option value="Science">
                                <option value="Games">
                                <option value="School">
                                <option value="Technology">
                                <option value="Art">
                            </datalist>
                            <div class="form-text">Create a new channel or select an existing one.</div>
                        </div>
                        <div class="mb-3">
                            <label for="groupDesc" class="form-label">Description</label>
                            <textarea class="form-control" id="groupDesc" rows="3"></textarea>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isPrivate">
                            <label class="form-check-label" for="isPrivate">Private Group</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const token = localStorage.getItem('token');

        async function loadMyGroups() {
            try {
                const res = await fetch('/api/users/groups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.setItem('redirectAfterLogin', window.location.href);
                    window.location.href = "{{ url_for('auth_page') }}";
                    return;
                }
                const data = await res.json();
                const groups = data.data?.groups || [];

                // Fetch unread counts
                let unreadMap = {};
                try {
                    const unreadRes = await fetch('/api/messages/unread/count', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const unreadData = await unreadRes.json();
                    (unreadData.data?.groups || []).forEach(g => {
                        unreadMap[g.group_id] = g.unread_count;
                    });
                } catch (e) {
                    console.warn('Failed to load unread counts:', e);
                }

                const html = groups.length ? groups.map(g => {
                    const groupId = g.id || g._id;
                    const unreadCount = unreadMap[groupId] || 0;
                    const unreadBadge = unreadCount > 0 
                        ? `<span class="badge bg-danger ms-2" title="${unreadCount} unread messages">${unreadCount > 99 ? '99+' : unreadCount}</span>` 
                        : '';
                    return `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-semibold" style="color: var(--text-dark);">${g.name}${unreadBadge}</h5>
                                <p class="card-text text-muted small">${g.description || 'No description'}</p>
                                <small class="text-muted">
                                    <i class="fas fa-users text-primary"></i> ${g.member_count || 0} members
                                    ${g.channel && g.channel.name ? `<span class="badge bg-primary bg-opacity-10 text-primary ms-2">${g.channel.name}</span>` : ''}
                                </small>
                                <div class="mt-auto pt-3">
                                    <button class="btn btn-sm btn-primary" onclick="viewGroup('${groupId}')"><i class="fas fa-eye me-1"></i>View</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="leaveGroup('${groupId}')"><i class="fas fa-sign-out-alt me-1"></i>Leave</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('') : '<div class="col-12 text-center text-muted py-4"><i class="fas fa-users fa-3x mb-3 opacity-25"></i><p>You haven\'t joined any groups yet</p></div>';

                document.getElementById('myGroupsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadAvailableGroups() {
            try {
                const res = await fetch('/api/groups/channels', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.setItem('redirectAfterLogin', window.location.href);
                    window.location.href = "{{ url_for('auth_page') }}";
                    return;
                }
                const data = await res.json();
                const channels = data.data?.channels || [];

                if (channels.length === 0) {
                    document.getElementById('availableGroupsAccordion').innerHTML = '<div class="col-12 text-center text-secondary"><p>No channels available</p></div>';
                    return;
                }

                let html = '';
                let index = 0;
                for (const channel of channels) {
                    const category = channel.name || 'General';
                    const categoryGroups = channel.groups || [];
                    html += `
                        <div class="accordion-item mb-3" style="border-radius: 12px; overflow: hidden;">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" style="background: var(--card-bg); color: var(--text-dark); font-weight: 600;">
                                    <i class="fas fa-hashtag text-primary me-2"></i>${category} <span class="badge bg-primary bg-opacity-10 text-primary ms-2">${categoryGroups.length} groups</span>
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#availableGroupsAccordion">
                                <div class="accordion-body p-3" style="background: var(--card-bg);">
                                    <div class="row g-4">
                                        ${categoryGroups.map(g => `
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100 shadow-sm border-0">
                                                    <div class="card-body d-flex flex-column">
                                                        <h5 class="card-title fw-semibold" style="color: var(--text-dark);">${g.name}</h5>
                                                        <p class="card-text text-muted small">${g.description || 'No description'}</p>
                                                        <small class="text-muted">
                                                            <i class="fas fa-users text-primary"></i> ${g.member_count || 0} members
                                                            ${g.is_private ? '<i class="fas fa-lock text-warning ms-2" title="Private"></i>' : '<i class="fas fa-globe text-success ms-2" title="Public"></i>'}
                                                        </small>
                                                        <div class="mt-auto pt-3">
                                                            ${g.is_member ? 
                                                                `<button class="btn btn-sm btn-outline-success" disabled><i class="fas fa-check me-1"></i>Joined</button>` : 
                                                                (g.is_pending ? 
                                                                    `<button class="btn btn-sm btn-secondary" disabled><i class="fas fa-clock me-1"></i>Request Sent</button>` : 
                                                                    `<button class="btn btn-sm btn-success" onclick="joinGroup('${g.id || g._id}', ${g.is_private})">
                                                                        <i class="fas fa-${g.is_private ? 'key' : 'plus'} me-1"></i>${g.is_private ? 'Request to Join' : 'Join'}
                                                                    </button>`
                                                                )
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    index++;
                }

                document.getElementById('availableGroupsAccordion').innerHTML = html;
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        async function joinGroup(groupId, isPrivate) {
            try {
                const res = await fetch(`/api/groups/${groupId}/join`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.setItem('redirectAfterLogin', window.location.href);
                    window.location.href = "{{ url_for('auth_page') }}";
                    return;
                }
                
                if (res.ok) {
                    if (isPrivate) {
                        await showCustomAlert('Join request sent successfully!', 'Request Sent');
                    } else {
                        await showCustomAlert('Joined group successfully!', 'Success');
                        loadMyGroups();
                        loadAvailableGroups();
                    }
                } else {
                    const data = await res.json();
                    await showCustomAlert(data.message || 'Failed to join group', 'Error');
                }
            } catch (error) {
                console.error('Error joining group:', error);
            }
        }

        function viewGroup(groupId) {
            // Store group ID and navigate to messages page filtered by group
            localStorage.setItem('selectedGroupId', groupId);
            window.location.href = "{{ url_for('messages_page') }}";
        }

        async function leaveGroup(groupId) {
            if (await showCustomConfirm('Are you sure you want to leave this group?', 'Leave Group')) {
                try {
                    const res = await fetch(`/api/groups/${groupId}/leave`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.status === 401) {
                        localStorage.removeItem('token');
                        sessionStorage.setItem('redirectAfterLogin', window.location.href);
                        window.location.href = "{{ url_for('auth_page') }}";
                        return;
                    }
                    if (res.ok) {
                        await showCustomAlert('Left group successfully!', 'Success');
                        loadMyGroups();
                        loadAvailableGroups();
                    }
                } catch (error) {
                    console.error('Error leaving group:', error);
                }
            }
        }

        document.getElementById('createGroupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch('/api/groups', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: document.getElementById('groupName').value,
                        description: document.getElementById('groupDesc').value,
                        category: document.getElementById('groupCategory').value,
                        is_private: document.getElementById('isPrivate').checked
                    })
                });
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.setItem('redirectAfterLogin', window.location.href);
                    window.location.href = "{{ url_for('auth_page') }}";
                    return;
                }
                if (res.ok) {
                    await showCustomAlert('Group created successfully!', 'Success');
                    document.getElementById('createGroupForm').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
                    if (modal) {
                        modal.hide();
                    }
                    loadMyGroups();
                    loadAvailableGroups();
                }
            } catch (error) {
                console.error('Error creating group:', error);
            }
        });

        async function loadPendingRequests() {
            try {
                const res = await fetch('/api/users/groups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const myGroups = data.data?.groups || [];
                
                let allRequests = [];
                
                for (const group of myGroups) {
                    try {
                        const reqRes = await fetch(`/api/groups/${group.id || group._id}/requests`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (reqRes.ok) {
                            const reqData = await reqRes.json();
                            const requests = reqData.data || [];
                            requests.forEach(r => {
                                r.groupName = group.name;
                                r.groupId = group.id || group._id;
                                allRequests.push(r);
                            });
                        }
                    } catch (e) {
                        // Ignore errors (e.g. not moderator)
                    }
                }
                
                if (allRequests.length > 0) {
                    document.getElementById('pendingRequestsTab').style.display = 'block';
                    const html = allRequests.map(u => `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h5 class="card-title">${u.username}</h5>
                                    <p class="card-text text-body-secondary">Wants to join <strong>${u.groupName}</strong></p>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-success" onclick="approveRequest('${u.groupId}', '${u.id || u._id}')">Approve</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectRequest('${u.groupId}', '${u.id || u._id}')">Reject</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('pendingRequestsList').innerHTML = html;
                } else {
                     document.getElementById('pendingRequestsList').innerHTML = '<div class="col-12 text-center text-muted py-5"><p>No pending requests.</p></div>';
                }
                
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        async function approveRequest(groupId, userId) {
            try {
                const res = await fetch(`/api/groups/${groupId}/requests/${userId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    await showCustomAlert('Request approved!', 'Success');
                    loadPendingRequests();
                    loadMyGroups(); // Update member count
                }
            } catch (error) {
                console.error('Error approving request:', error);
            }
        }

        async function rejectRequest(groupId, userId) {
             try {
                const res = await fetch(`/api/groups/${groupId}/requests/${userId}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    await showCustomAlert('Request rejected!', 'Success');
                    loadPendingRequests();
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = "{{ url_for('auth_page') }}";
                return;
            }
            loadMyGroups();
            loadAvailableGroups();
            loadPendingRequests();
        });
    </script>
{% endblock %}