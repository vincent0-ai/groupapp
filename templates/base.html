<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Discussio - A collaborative learning platform for groups, discussions, and competitions.">

    <title>{% block title %}Discussio{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Favicon and PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/images/favicon.ico" sizes="any">
    <link rel="icon" href="/static/images/badge-72.png" type="image/png" sizes="72x72">
    <link rel="apple-touch-icon" href="/static/images/icon-192.png">

    {% block head %}{% endblock %}
</head>
<body>
{% set ep = request.endpoint %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container-fluid px-3 px-lg-4">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard') }}">
            üéì Discussio
        </a>
        
        <!-- Notification Bell & User Actions (visible on mobile) -->
        <div class="d-flex align-items-center gap-2 d-lg-none">
            <div class="dropdown">
                <button class="btn btn-link position-relative p-2 notification-btn" id="notifBellMobile" data-bs-toggle="dropdown" data-bs-auto-close="outside" style="color: var(--text-body);">
                    üîî
                    <span class="notification-badge" id="notifBadgeMobile" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end notification-dropdown" style="width: 320px; max-height: 400px; overflow-y: auto; background: var(--cream-bg); border-color: var(--border-color);">
                    <div class="dropdown-header d-flex justify-content-between align-items-center" style="color: var(--text-heading);">
                        <strong>Notifications</strong>
                        <button class="btn btn-link btn-sm p-0" id="markAllReadMobile" style="color: var(--primary-light);">Mark all read</button>
                    </div>
                    <div id="notificationListMobile" class="notification-list">
                        <div class="text-center py-3" style="color: var(--text-muted);">No notifications</div>
                    </div>
                </div>
            </div>
            <button class="navbar-toggler border-0 shadow-none" type="button" id="navbarToggler" aria-label="Toggle navigation" style="color: var(--text-body);">
                ‚ò∞
            </button>
        </div>
        
        <div class="navbar-collapse" id="navbarNav">
            <button class="mobile-menu-close d-lg-none" id="menuClose" aria-label="Close menu">
                ‚úï
            </button>
            <ul class="navbar-nav ms-auto" id="navbarList">
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'groups_page' %}active{% endif %}" href="{{ url_for('groups_page') }}">Channels</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'messages_page' %}active{% endif %}" href="{{ url_for('messages_page') }}">Messages</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'dm_page' %}active{% endif %}" href="{{ url_for('dm_page') }}">DMs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'competitions_page' %}active{% endif %}" href="{{ url_for('competitions_page') }}">Competitions</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'files_page' %}active{% endif %}" href="{{ url_for('files_page') }}">Files</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'leaderboard_page' %}active{% endif %}" href="{{ url_for('leaderboard_page') }}">Leaderboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'profile_page' %}active{% endif %}" href="{{ url_for('profile_page') }}">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if ep == 'whiteboard_page' %}active{% endif %}" href="{{ url_for('whiteboard_page') }}">Whiteboard</a>
                </li>
                <!-- Notification Bell (Desktop) -->
                <li class="nav-item dropdown d-none d-lg-block">
                    <button class="btn btn-link nav-link position-relative notification-btn" id="notifBellDesktop" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                        üîî
                        <span class="notification-badge" id="notifBadgeDesktop" style="display: none;">0</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end notification-dropdown" style="width: 360px; max-height: 450px; overflow-y: auto;">
                        <div class="dropdown-header d-flex justify-content-between align-items-center">
                            <strong>Notifications</strong>
                            <button class="btn btn-link btn-sm p-0" id="markAllReadDesktop">Mark all read</button>
                        </div>
                        <div id="notificationListDesktop" class="notification-list">
                            <div class="text-center py-3 text-muted">No notifications</div>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link logout-link" id="logoutBtn" href="#">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="navbar-backdrop" id="navbarBackdrop"></div>
{% endblock %}

{% block body %}
<main class="{% block main_class %}container py-4{% endblock %}">
    {% block main_inner %}
    <div class="card glass-card shadow-lg border-0 rounded-4">
        <div class="card-body p-4">
            {% block content %}{% endblock %}
        </div>
    </div>
    {% endblock %}
</main>
{% endblock %}

{% block footer %}
<footer class="fixed-bottom border-top py-2 d-md-none" id="mobileBottomNav" style="background: rgba(12, 10, 29, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-color: var(--border-color) !important;">
    <div class="container-fluid">
        <div class="d-flex justify-content-around align-items-center">
            <a href="{{ url_for('dashboard') }}" class="footer-nav-link text-center text-decoration-none {% if ep == 'dashboard' %}active{% endif %}">
                <span class="nav-emoji">üè†</span>
                <small class="d-block">Home</small>
            </a>
            <a href="{{ url_for('groups_page') }}" class="footer-nav-link text-center text-decoration-none {% if ep == 'groups_page' %}active{% endif %}">
                <span class="nav-emoji">üë•</span>
                <small class="d-block">Groups</small>
            </a>
            <a href="{{ url_for('dm_page') }}" class="footer-nav-link text-center text-decoration-none {% if ep == 'dm_page' %}active{% endif %}">
                <span class="nav-emoji">üí¨</span>
                <small class="d-block">DMs</small>
            </a>
            <a href="{{ url_for('profile_page') }}" class="footer-nav-link text-center text-decoration-none {% if ep == 'profile_page' %}active{% endif %}">
                <span class="nav-emoji">üë§</span>
                <small class="d-block">Profile</small>
            </a>
            <a href="#" class="footer-nav-link text-center text-decoration-none" data-bs-toggle="offcanvas" data-bs-target="#mobileMoreSheet">
                <span class="nav-emoji">‚Ä¢‚Ä¢‚Ä¢</span>
                <small class="d-block">More</small>
            </a>
        </div>
    </div>
</footer>

<!-- Mobile More Bottom Sheet -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="mobileMoreSheet" style="height: auto; max-height: 70vh; border-radius: 20px 20px 0 0; background: var(--cream-bg);">
    <div class="offcanvas-header" style="border-bottom: 1px solid var(--border-color);">
        <h5 class="offcanvas-title" style="color: var(--text-heading);">More Options</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body pb-4">
        <div class="list-group list-group-flush">
            <a href="{{ url_for('messages_page') }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3" style="background: transparent; color: var(--text-body); border-color: var(--border-color);">
                <span>Group Messages</span>
            </a>
            <a href="{{ url_for('competitions_page') }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3" style="background: transparent; color: var(--text-body); border-color: var(--border-color);">
                <span>Competitions</span>
            </a>
            <a href="{{ url_for('files_page') }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3" style="background: transparent; color: var(--text-body); border-color: var(--border-color);">
                <span>Files</span>
            </a>
            <a href="{{ url_for('leaderboard_page') }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3" style="background: transparent; color: var(--text-body); border-color: var(--border-color);">
                <span>Leaderboard</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3" data-bs-toggle="modal" data-bs-target="#aboutModal" data-bs-dismiss="offcanvas" style="background: transparent; color: var(--text-body); border-color: var(--border-color);">
                <span>About</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3" id="mobileLogoutBtn" style="background: transparent; color: var(--danger-color); border-color: var(--border-color);">
                <span>Logout</span>
            </a>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--cream-bg); color: var(--text-body);">
            <div class="modal-header" style="border-color: var(--border-color);">
                <h5 class="modal-title" id="aboutModalLabel" style="color: var(--text-heading);">üéì About Discussio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-4" style="font-size: 3rem;">
                    üéì
                </div>
                <h4 class="mb-3 fw-bold">Discussio</h4>
                <p class="text-muted mb-4">A modern collaborative learning platform for groups, discussions, and competitions.</p>
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <span class="badge bg-primary">Groups</span>
                    <span class="badge bg-success">Chat</span>
                    <span class="badge bg-warning">Compete</span>
                </div>
                <hr>
                <p class="small text-muted mb-1">&copy; {{ now().year if now is defined else '2025' }} Discussio</p>
                <p class="small text-muted mb-0">Version 1.0.0</p>
            </div>
            <div class="modal-footer justify-content-center border-0 pt-0">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .footer-nav-link {
        color: var(--text-muted);
        padding: 8px 20px;
        transition: all 0.25s ease;
        border-radius: 12px;
    }
    .footer-nav-link:hover {
        color: var(--primary-color);
        background: rgba(79, 70, 229, 0.06);
    }
    .footer-nav-link.active {
        color: var(--primary-color);
        background: rgba(79, 70, 229, 0.08);
    }
    .footer-nav-link i {
        font-size: 1.25rem;
        display: block;
        margin-bottom: 2px;
    }
    .footer-nav-link small {
        font-size: 0.7rem;
        font-weight: 500;
    }
    /* Add padding to main content to prevent footer overlap */
    main {
        padding-bottom: 80px !important;
    }
    
    /* Notification Center Styles */
    .notification-badge {
        position: absolute;
        top: 2px;
        right: 2px;
        background: #ef4444;
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 2px 5px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
    }
    .notification-dropdown {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        padding: 0;
        background: white;
    }
    .notification-dropdown .dropdown-header {
        background: rgba(79, 70, 229, 0.08);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
    }
    .notification-list {
        max-height: 350px;
        overflow-y: auto;
    }
    .notification-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.15s ease;
    }
    .notification-item:hover {
        background: rgba(79, 70, 229, 0.04);
    }
    .notification-item.unread {
        background: rgba(79, 70, 229, 0.06);
    }
    .notification-item .notif-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .notification-item .notif-icon.mention { background: rgba(79, 70, 229, 0.12); color: #4F46E5; }
    .notification-item .notif-icon.message { background: rgba(34, 197, 94, 0.12); color: #22C55E; }
    .notification-item .notif-icon.join { background: rgba(245, 158, 11, 0.12); color: #F59E0B; }
    .notification-item .notif-icon.announcement { background: rgba(239, 68, 68, 0.12); color: #EF4444; }
    .notification-item .notif-icon.dm { background: rgba(99, 102, 241, 0.12); color: #6366F1; }
    .notification-item .notif-content {
        flex: 1;
        min-width: 0;
    }
    .notification-item .notif-content p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-heading);
    }
    .notification-item .notif-content small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }
    .notification-item .notification-text {
        color: #1E293B;
        font-size: 0.875rem;
        margin-bottom: 2px;
    }
    .notification-item.unread .notification-text {
        font-weight: 600;
    }
    
    /* Online Status Indicator */
    .online-indicator {
        width: 10px;
        height: 10px;
        background: #10b981;
        border-radius: 50%;
        border: 2px solid white;
        position: absolute;
        bottom: 0;
        right: 0;
    }
    .online-indicator.offline {
        background: #94a3b8;
    }
    
    @media (prefers-color-scheme: dark) {
        footer {
            background: rgba(15, 23, 42, 0.95) !important;
        }
        .notification-dropdown {
            background: var(--card-bg);
        }
    }
    
    @media (max-width: 991.98px) {
        .notification-dropdown {
            background-color: #fff !important;
        }
    }
</style>
{% endblock %}

{% block modals %}{% endblock %}

<!-- Global Confirmation Modal -->
<div class="modal fade" id="globalConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="globalConfirmTitle">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="globalConfirmMessage">
                Are you sure?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="globalConfirmCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="globalConfirmOK">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Global Alert Modal -->
<div class="modal fade" id="globalAlertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="globalAlertTitle">Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="globalAlertMessage">
                Alert message.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/pwa.js') }}"></script>
<script>
    // Global Custom Alert/Confirm
    window.showCustomAlert = function(message, title = 'Alert') {
        return new Promise((resolve) => {
            document.getElementById('globalAlertTitle').textContent = title;
            document.getElementById('globalAlertMessage').textContent = message;
            const modalEl = document.getElementById('globalAlertModal');
            // Use getOrCreateInstance to prevent multiple modal instances and backdrop stacking
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            
            const onHidden = () => {
                modalEl.removeEventListener('hidden.bs.modal', onHidden);
                resolve();
            };
            modalEl.addEventListener('hidden.bs.modal', onHidden);
            
            modal.show();
        });
    };

    // Sync auth cookie to localStorage so server-rendered pages and legacy scripts
    // that read localStorage 'token' continue to function when the app uses
    // HttpOnly cookie-based auth for browser navigation.
    (function syncAuthCookie() {
        try {
            if (!localStorage.getItem('token')) {
                const cookie = document.cookie.split('; ').find(r => r.startsWith('auth_token='));
                if (cookie) {
                    const val = cookie.split('=')[1];
                    if (val) {
                        localStorage.setItem('token', val);
                        try {
                            const payload = JSON.parse(atob(val.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                            if (payload && payload.user_id) localStorage.setItem('userId', String(payload.user_id));
                        } catch (e) { /* ignore parse errors */ }
                    }
                }
            }
        } catch (e) {
            console.debug('Auth cookie sync failed:', e);
        }
    })();

    window.showCustomConfirm = function(message, title = 'Confirmation') {
        return new Promise((resolve) => {
            document.getElementById('globalConfirmTitle').textContent = title;
            document.getElementById('globalConfirmMessage').textContent = message;
            const modalEl = document.getElementById('globalConfirmModal');
            // Use getOrCreateInstance to prevent multiple modal instances and backdrop stacking
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            const okBtn = document.getElementById('globalConfirmOK');
            
            let result = false;
            
            const onOk = () => {
                result = true;
                modal.hide();
            };
            
            const onHidden = () => {
                okBtn.removeEventListener('click', onOk);
                modalEl.removeEventListener('hidden.bs.modal', onHidden);
                resolve(result);
            };
            
            okBtn.addEventListener('click', onOk);
            modalEl.addEventListener('hidden.bs.modal', onHidden);
            
            modal.show();
        });
    };

    // Override default alert/confirm (optional, but safer to use explicit calls for async)
    // We won't override window.confirm because it must be synchronous.
    // We can override window.alert but it won't block execution.
    // For this task, we will replace usages with the async versions.

    document.addEventListener('DOMContentLoaded', () => {
        // Logout
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                // Attempt server-side logout to clear cookie, then clear local storage
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                } catch (err) { /* ignore */ }
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                window.location.href = "{{ url_for('auth_page') }}";
            });
        }

        // Check if user is admin and add admin link
        const token = localStorage.getItem('token');
        if (token) {
            fetch('/api/users/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.data && data.data.is_admin) {
                    const navbarList = document.getElementById('navbarList');
                    if (navbarList && !document.getElementById('adminLink')) {
                        const li = document.createElement('li');
                        li.className = 'nav-item';
                        li.innerHTML = `<a class="nav-link" id="adminLink" href="/admin">üõ°Ô∏è Admin</a>`;
                        // Insert before Logout (last item)
                        navbarList.insertBefore(li, navbarList.lastElementChild);
                    }
                }
            })
            .catch(err => console.warn('Could not check admin status:', err));
        }

        // Mobile menu
        const navbarToggler = document.getElementById('navbarToggler');
        const navbarCollapse = document.getElementById('navbarNav');
        const navbarBackdrop = document.getElementById('navbarBackdrop');
        const menuClose = document.getElementById('menuClose');

        function openMenu() {
            if (!navbarCollapse || !navbarBackdrop) return;
            navbarCollapse.classList.add('show');
            navbarBackdrop.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            if (!navbarCollapse || !navbarBackdrop) return;
            navbarCollapse.classList.remove('show');
            navbarBackdrop.classList.remove('show');
            document.body.style.overflow = '';
        }

        if (navbarToggler) navbarToggler.addEventListener('click', openMenu);
        if (menuClose) menuClose.addEventListener('click', closeMenu);
        if (navbarBackdrop) navbarBackdrop.addEventListener('click', closeMenu);

        // Notification Center
        initNotificationCenter();
    });

    // Notification Center Manager
    function initNotificationCenter() {
        const token = localStorage.getItem('token');
        if (!token) return;

        // Load notifications on page load
        loadNotifications();

        // Poll for new notifications every 30 seconds
        setInterval(loadNotifications, 30000);

        // Mark all read buttons
        document.querySelectorAll('.mark-all-read').forEach(btn => {
            btn.addEventListener('click', markAllAsRead);
        });
    }

    async function loadNotifications() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch('/api/notifications', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.success && data.data) {
                renderNotifications(data.data.notifications || []);
                updateNotificationBadge(data.data.unread_count || 0);
            }
        } catch (err) {
            console.warn('Failed to load notifications:', err);
        }
    }

    function renderNotifications(notifications) {
        const listMobile = document.getElementById('notificationListMobile');
        const listDesktop = document.getElementById('notificationListDesktop');

        const html = notifications.length === 0 
            ? '<div class="text-center text-muted py-4" style="font-size: 2rem;">üîï</div><div class="text-center text-muted"><p class="mb-0">No notifications yet</p></div>'
            : notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" data-id="${n._id}" onclick="handleNotificationClick('${n._id}', '${n.link || ''}')">
                    <div class="d-flex align-items-start gap-2">
                        <span class="mt-1">${getNotificationIcon(n.type)}</span>
                        <div class="flex-grow-1">
                            <div class="notification-text">${escapeHtml(n.message)}</div>
                            <small class="text-muted">${formatTimeAgo(n.created_at)}</small>
                        </div>
                        ${!n.read ? '<span class="badge bg-primary">New</span>' : ''}
                    </div>
                </div>
            `).join('');

        if (listMobile) listMobile.innerHTML = html;
        if (listDesktop) listDesktop.innerHTML = html;
    }

    function updateNotificationBadge(count) {
        document.querySelectorAll('.notification-badge').forEach(badge => {
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        });
    }

    function getNotificationIcon(type) {
        const icons = {
            'mention': 'üì£',
            'message': 'üí¨',
            'join_request': 'üë§',
            'announcement': 'üì¢',
            'reaction': '‚ù§Ô∏è',
            'group_invite': 'üë•',
            'dm': '‚úâÔ∏è'
        };
        return icons[type] || 'üîî';
    }

    function formatTimeAgo(dateStr) {
        let date = new Date(dateStr);
        // Handle naive UTC strings from server by treating them as UTC
        if (typeof dateStr === 'string' && dateStr.includes('T') && !dateStr.endsWith('Z') && !dateStr.includes('+')) {
            date = new Date(dateStr + 'Z');
        }

        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
        return date.toLocaleDateString();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function handleNotificationClick(id, link) {
        const token = localStorage.getItem('token');
        if (!token) return;

        // Mark as read
        try {
            await fetch(`/api/notifications/${id}/read`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
        } catch (err) {
            console.warn('Failed to mark notification as read:', err);
        }

        // Navigate if link provided
        if (link) {
            window.location.href = link;
        } else {
            loadNotifications();
        }
    }

    async function markAllAsRead() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            await fetch('/api/notifications/read-all', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadNotifications();
        } catch (err) {
            console.warn('Failed to mark all as read:', err);
        }
    }
    
    // Mobile logout button
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location.href = "{{ url_for('auth_page') }}";
        });
    }
</script>

{% block scripts %}{% endblock %}
</body>
</html>
